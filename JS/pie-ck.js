var w=300,h=300,r=100,color=d3.scale.category20c(),inPie=function(e,t){this.maxIconScale=1.5;this.initScale=1;this.icons=[];this.w=e;this.h=t;this.r=Math.min(this.w,this.h)/2;this.offset={x:this.w/2,y:this.h/2};this.textPad=12;this.sliceScale=this.r};inPp=inPie.prototype;Object.defineProperty(inPp,"dataset",{get:function(){return this.data},set:function(e){this.data=e;this.update()}});inPp.build=function(e,t,n){this.icons=n;this.data=t;var i=this;this.vis=d3.select(e).append("svg:svg").attr("width",this.w).attr("height",this.w);this.svg=this.vis.append("svg:g").attr("transform","translate("+this.offset.x+","+this.offset.y+")").attr("class","pie");_rad=this.r;this.arc=d3.svg.arc().outerRadius(this.r).innerRadius(0);this.pie=d3.layout.pie().value(function(e){return e.weight}).sort(null);this.slices=this.svg.selectAll("g.slice").data(this.pie(this.data)).enter().append("svg:g").attr("class","slice");this.slices.append("svg:path").attr("fill",function(e,t){return null}).style("fill-opacity","0").attr("d",this.arc);this.icongroup=this.slices.append("g").attr("class","icongroup").attr("id",function(e){return e.data.ser_id}).attr("transform",function(e){e.innerRadius=0;e.outerRadius=r;return"translate("+i.arc.centroid(e)+")"});this.scaleByWeight=function(e){var t=+e.data.weight;t/=100;t*=i.sliceScale;return t};this.slices.each(function(e){var t=function(e){var t=document.createElement("g");e=e.cloneNode(!0);while(e.firstChild)t.appendChild(e.firstChild);return t};i.initScale=e.data.weight;document.getElementById(e.data.ser_id).appendChild(i.icons[e.data.ser_id])});this.icongroup.select("svg").attr({x:function(e){return-i.scaleByWeight(e)/2},y:function(e){return-i.scaleByWeight(e)/2},transform:null,height:function(e){return i.scaleByWeight(e)},width:function(e){return i.scaleByWeight(e)},style:null,version:null});this.foreignBody=this.icongroup.append("foreignObject").attr({width:function(e){return i.scaleByWeight(e)*1.5},height:"100px",x:function(e){return-i.scaleByWeight(e)/2*1.5},y:function(e){return i.scaleByWeight(e)/2},style:"color:white"}).append("xhtml:body").attr("class","foreign");this.foreignBody.append("p").attr({"class":"series_label"}).text(function(e,t){return i.data[t].program_name});this.weightLabel=this.foreignBody.append("h2").attr({"class":"series_weight"}).text(function(e,t){return i.data[t].weight.toFixed(0)+"%"});var s,o;this.dragProp={w:100,h:100,off:50};this.dragBody=this.svg.append("foreignObject").attr({width:this.dragProp.w,height:this.dragProp.h,"class":"dragBody inactive"});this.dragBody.append("xhtml:body").attr("class","dragImg").append("img").attr("src","SVG/drag.svg");this.drag=d3.behavior.drag().origin(null).on("dragstart",function(){s=u(d3.event).deg;o=s}).on("drag",function(e,t){i.dragBody.classed("inactive",!1);dData=i.data;var n=u(d3.event);i.dragBody.attr({transform:"translate("+(n.x-i.dragProp.off)+" "+(n.y-i.dragProp.off)+" ) rotate("+n.deg+" 50 50)"});delta=n.deg-o;thisI=t;Math.abs(delta)<10&&dData.forEach(function(e,t){check=thisI==t;dData[t].weight+=check?delta/3.6:-delta/3.6});i.dataset=dData;o=n.deg}).on("dragend",function(){i.dragBody.classed("inactive",!0)});var u=function(e){console.log(e);var t=Math.PI;res={};var n={},r={};r.x=e.sourceEvent.clientX;r.y=e.sourceEvent.clientY;n.x=e.sourceEvent.clientX-i.offset.x+16;n.y=e.sourceEvent.clientY-i.offset.y+32;res.x=+e.x;res.y=+e.y;res.client=r;res.mouse=n;res.radians=Math.atan2(res.y,res.x)+t;res.deg=res.radians*(180/t);return res};this.slices.call(this.drag)};inPp.update=function(){var e=2;_self=this;this.slices.data(this.pie(this.data));this.slices.select("path").attr("d",this.arc).transition().duration(100);this.slices.select(".icongroup").attr("transform",function(e){e.innerRadius=0;e.outerRadius=r;var t=e.data.weight/_self.initScale;t=t>1?1:t;return"translate("+_self.arc.centroid(e)+") scale("+t+","+t+")"});this.foreignBody.select("h2").text(function(e,t){return _self.data[t].weight.toFixed(2)+"%"});var t=0,n="",i="";this.data.forEach(function(e,r){var i=e.value*e.weight;n+=e.value+",";t+=i});console.log("Weighted sum: "+t/100);console.log("values: "+n);var s=t/100;$.event.trigger({type:"RATE",rate:s.toFixed(2)})};