var w=300,h=300,r=100,color=d3.scale.category20c(),inPie=function(e,t){this.initScale=1;this.icons=[];this.w=e;this.h=t;this.r=Math.min(this.w,this.h)/2;this.offset={x:this.w/2,y:this.h/2};this.textPad=12;this.sliceScale=this.r;this.data=[{label:"one",value:1,weight:2},{label:"two",value:1,weight:2},{label:"three",value:2,weight:2},{label:"four",value:3,weight:2}]};inPp=inPie.prototype;Object.defineProperty(inPp,"dataset",{get:function(){return this.data},set:function(e){this.data=e;console.log("DATASET RECEIVED");this.update()}});inPp.build=function(e,t,n){function a(e){delta=e-o;return delta}this.icons=n;this.data=t;var i=this;this.vis=d3.select(e).append("svg:svg").attr("width",this.w).attr("height",this.w);this.svg=this.vis.append("svg:g").attr("transform","translate("+this.offset.x+","+this.offset.y+")").attr("class","pie");_rad=this.r;this.arc=d3.svg.arc().outerRadius(this.r).innerRadius(0);var s,o,u=function(e){var t=Math.PI;res={};var n={};n.x=e.sourceEvent.clientX-i.offset.x;n.y=e.sourceEvent.clientY-i.offset.y;res.mouse=n;res.radians=Math.atan2(res.mouse.y,res.mouse.x)+t;res.deg=res.radians*(180/t);return res};this.drag=d3.behavior.drag().origin(null).on("dragstart",function(){s=u(d3.event).deg;o=s;console.log("initial Angle :: "+s)}).on("drag",function(e,t){dData=i.data;var n=u(d3.event);delta=n.deg-o;thisI=t;Math.abs(delta)<10&&dData.forEach(function(e,t){check=thisI==t;dData[t].weight+=check?delta/3.6:-delta/3.6});i.dataset=dData;o=n.deg});this.pie=d3.layout.pie().value(function(e){return e.weight}).sort(null);this.arcs=this.svg.selectAll("g.slice").data(this.pie(this.data));this.slices=this.arcs.enter().append("svg:g").attr("class","slice");this.arcs.call(this.drag);this.arcs.append("svg:path").attr("fill",function(e,t){return color(t)}).attr("d",this.arc);this.icongroup=this.slices.append("g").attr("class","icongroup").attr("id",function(e){return e.data.ser_id}).attr("transform",function(e){e.innerRadius=0;e.outerRadius=r;return"translate("+i.arc.centroid(e)+")"});this.icongroup.selectAll("path").attr("fill",null);this.scaleByWeight=function(e){var t=+e.data.weight;t/=200;t*=i.sliceScale;return t};this.slices.each(function(e){i.initScale=e.data.weight;document.getElementById(e.data.ser_id).appendChild(icons[e.data.ser_id])});this.icongroup.select("svg").attr({x:function(e){return-i.scaleByWeight(e)/2},y:function(e){return-i.scaleByWeight(e)/2},transform:null,height:function(e){return i.scaleByWeight(e)},width:function(e){return i.scaleByWeight(e)},style:null});this.icongroup.append("svg:text").attr({"text-anchor":"middle","class":"series_label",y:function(e){return i.scaleByWeight(e)/2+i.textPad},width:function(e){return i.scaleByWeight(e)}}).text(function(e,t){return i.data[t].program_name})};inPp.update=function(){_self=this;this.arcs.data(this.pie(this.data));this.arcs.select("path").attr("d",this.arc).transition().duration(100);this.arcs.select(".icongroup").attr("transform",function(e){e.innerRadius=0;e.outerRadius=r;return"translate("+_self.arc.centroid(e)+") scale("+e.data.weight/_self.initScale+","+e.data.weight/_self.initScale+")"});var e=0;this.data.forEach(function(t,n){var r=t.value*t.weight;console.log("weighted value :"+r);e+=r});console.log("sum :"+e);var t=e/100;console.log("average rate :"+t);$.event.trigger({type:"RATE",rate:t.toFixed(2)})};inPp.timeout=setTimeout(function(){});inPp.arcTween=function(t){var n=d3.interpolate(this._current,t);this._current=n(0);return function(e){return arc(n(e))}};inPp.randomize=function(){this.dataset=[{label:"one",value:Math.random()*99},{label:"two",value:Math.random()*99},{label:"three",value:Math.random()*99}]};